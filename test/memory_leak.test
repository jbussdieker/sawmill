#!/bin/bash
(
	for i in {1..500000}; do
	  echo "\"asdfqwer\""
	done
) | ./src/sawmill --host localhost --port -1 - &
PID=`ps -edf | grep "sawmill " | grep -v grep | awk '{print $2}'`
START_RSS=`ps -y -l -p $PID | tail -n 1 | awk '{print $8}'`

for i in {1..15}; do
  # Still running?
  # TODO: This doesn't detect duplicate processes
  ps -edf | grep "$PID " | grep -v grep &> /dev/null
  [[ "$?" != "0" ]] && break

  # Print RSS and sleep
  RSS=`ps -y -l -p $PID | tail -n 1 | awk '{print $8}'`
  echo "Memory Usage: $RSS KB"

  sleep 1
done

if [[ "x$START_RSS" != "x$RSS" ]]; then
  echo "Memory Leak Detected!"
  exit 1
fi

exit 0
